/*
 *
 *  Copyright (C) 2025 Bitsea GmbH
 *  *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 *  SPDX-License-Identifier: Apache-2.0
 *  License-Filename: LICENSE
 * /
 *
 */

package eu.occtet.boc.vulnerability.service;

import eu.occtet.boc.entity.SoftwareComponent;
import eu.occtet.boc.entity.Vulnerability;
import eu.occtet.boc.vulnerability.dao.SoftwareComponentRepository;
import eu.occtet.boc.vulnerability.dao.VulnerabilityRepository;
import eu.occtet.boc.vulnerability.factory.VulnerabilityFactory;
import eu.occtet.boc.vulnerability.model.vulnerablecode.PackageApiResponseDto;
import eu.occtet.boc.vulnerability.model.vulnerablecode.PackageResultDto;
import eu.occtet.boc.vulnerability.model.vulnerablecode.VulnerabilityDto;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.autoconfigure.web.reactive.AutoConfigureWebTestClient;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.web.client.RestClient;

import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;

@DataJpaTest
@ContextConfiguration(classes = {VulnerabilityDataService.class, VulnerabilityService.class, SoftwareComponentRepository.class,
        VulnerabilityRepository.class, VulnerabilityFactory.class})
@EnableJpaRepositories(basePackages = "eu.occtet.boc.vulnerability.dao")
@EntityScan(basePackages = "eu.occtet.boc.entity")
@ExtendWith(MockitoExtension.class)
public class VulnerabilityDataServiceTest {

    @MockitoBean
    private VulnerableCodeApiClient vulnerableCodeApiClient;

    @Autowired
    private SoftwareComponentRepository softwareComponentRepository;
    @Autowired
    private VulnerabilityDataService vulnerabilityDataService;

    @Test
    void testGenerateVulnerabilitiesOfVulnerablePackageUsingPurl(){

        Mockito.when(vulnerableCodeApiClient.getPackageData(Mockito.any()))
                .thenReturn(Optional.of(new PackageApiResponseDto(1,"","",
                        List.of(new PackageResultDto("","","","","","","",
                                true,"","",
                                List.of(new VulnerabilityDto("","VCID-nze3-w2ta-aaas","Deserialization of Untrusted Data in Gson",
                                        Collections.emptyList(),Collections.emptyList(),
                                        List.of("CVE-2022-25647","GHSA-4jrv-ppp4-jm57"),
                                        4.0,"0.5","8.0","http://public.vulnerablecode.io/vulnerabilities/VCID-nze3-w2ta-aaas")),
                                Collections.emptyList(),0.0,"")))));

         SoftwareComponent softwareComponent = new SoftwareComponent();
         softwareComponent.setPurl("pkg:maven/com.google.code.gson/gson@1.1");
         softwareComponent.setName("");
         softwareComponent.setVersion("");
         softwareComponentRepository.save(softwareComponent);
         List<Vulnerability> vulnerabilityList = vulnerabilityDataService.generateVulnerabilities(softwareComponent.getId());

         assertEquals(1, vulnerabilityList.size());
         Vulnerability vulnerability = vulnerabilityList.getFirst();
         assertEquals("VCID-nze3-w2ta-aaas", vulnerability.getVulnerabilityId());
         assertEquals("Deserialization of Untrusted Data in Gson", vulnerability.getSummary());

         String expectedAlias1 = "CVE-2022-25647";
         String expectedAlias2 = "GHSA-4jrv-ppp4-jm57";
         assertTrue(vulnerability.getAliases().contains(expectedAlias1));
         assertTrue(vulnerability.getAliases().contains(expectedAlias2));

         assertEquals(8.0, vulnerability.getWeightedSeverity());
         assertEquals(0.5, vulnerability.getExploitability());
         assertEquals(4.0, vulnerability.getRiskScore());


        assertEquals("http://public.vulnerablecode.io/vulnerabilities/VCID-nze3-w2ta-aaas", vulnerability.getSourceUrl());

    }

    // FIXME check the following tests if needed (see issue https://github.com/Bitsea/Occtet-Curator/issues/31)

    //@Test
    void testGenerateVulnerabilitiesOfVulnerablePackageUsingNameAndVersion(){
        SoftwareComponent softwareComponent = new SoftwareComponent();
        softwareComponent.setName("gson");
        softwareComponent.setVersion("1.1");
        softwareComponentRepository.save(softwareComponent);
        List<Vulnerability> vulnerabilityList = vulnerabilityDataService.generateVulnerabilities(softwareComponent.getId());

        assertEquals(1, vulnerabilityList.size());
        Vulnerability vulnerability = vulnerabilityList.getFirst();
        assertEquals("VCID-nze3-w2ta-aaas", vulnerability.getVulnerabilityId());
        assertEquals("Deserialization of Untrusted Data in Gson", vulnerability.getSummary());

        String expectedAlias1 = "CVE-2022-25647";
        String expectedAlias2 = "GHSA-4jrv-ppp4-jm57";
        assertTrue(vulnerability.getAliases().contains(expectedAlias1));
        assertTrue(vulnerability.getAliases().contains(expectedAlias2));

        assertEquals(8.0, vulnerability.getWeightedSeverity());
        assertEquals(0.5, vulnerability.getExploitability());
        assertEquals(4.0, vulnerability.getRiskScore());

        assertEquals("http://public.vulnerablecode.io/packages/pkg:maven/com.google.code.gson/gson@2.8.9",
                vulnerability.getFixedPackages().getFirst());
        assertEquals("http://public.vulnerablecode.io/vulnerabilities/VCID-nze3-w2ta-aaas", vulnerability.getSourceUrl());

    }

    //@Test
    void testGenerateVulnerabilitiesOfVulnerablePackageUsingOnlyName(){
        SoftwareComponent softwareComponent = new SoftwareComponent();
        softwareComponent.setName("gson");
        softwareComponent.setVersion("");
        softwareComponentRepository.save(softwareComponent);
        List<Vulnerability> vulnerabilityList = vulnerabilityDataService.generateVulnerabilities(softwareComponent.getId());

        assertEquals(1, vulnerabilityList.size());
        Vulnerability vulnerability = vulnerabilityList.getFirst();
        assertEquals("VCID-nze3-w2ta-aaas", vulnerability.getVulnerabilityId());
        assertEquals("Deserialization of Untrusted Data in Gson", vulnerability.getSummary());

        String expectedAlias1 = "CVE-2022-25647";
        String expectedAlias2 = "GHSA-4jrv-ppp4-jm57";
        assertTrue(vulnerability.getAliases().contains(expectedAlias1));
        assertTrue(vulnerability.getAliases().contains(expectedAlias2));

        assertEquals(8.0, vulnerability.getWeightedSeverity());
        assertEquals(0.5, vulnerability.getExploitability());
        assertEquals(4.0, vulnerability.getRiskScore());

        assertEquals("http://public.vulnerablecode.io/packages/pkg:maven/com.google.code.gson/gson@2.8.9",
                vulnerability.getFixedPackages().getFirst());
        assertEquals("http://public.vulnerablecode.io/vulnerabilities/VCID-nze3-w2ta-aaas", vulnerability.getSourceUrl());
        assertEquals(45, vulnerability.getReferences().size());
    }

    //@Test
    void testGenerateVulnerabilitiesOfInvulnerablePackage(){
        SoftwareComponent softwareComponent = new SoftwareComponent();
        softwareComponent.setPurl("pkg:alpine/junit@4.13.1-r0?arch=aarch64&distroversion=edge&reponame=community");
        softwareComponent.setName("junit");
        softwareComponent.setVersion("4.13.1-r0");
        softwareComponentRepository.save(softwareComponent);
        List<Vulnerability> vulnerabilityList = vulnerabilityDataService.generateVulnerabilities(softwareComponent.getId());

        assertTrue(vulnerabilityList.isEmpty());
    }

    //@Test
    void testGenerateVulnerabilitiesOfInvalidInput(){
        List<Vulnerability> vulnerabilityList = vulnerabilityDataService.generateVulnerabilities(UUID.randomUUID());

        assertTrue(vulnerabilityList.isEmpty());
    }
}
