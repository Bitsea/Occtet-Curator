/*
 *
 *  Copyright (C) 2025 Bitsea GmbH
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 *  SPDX-License-Identifier: Apache-2.0
 *  License-Filename: LICENSE
 *
 *
 */

package eu.occtet.boc.vulnerability.service;

import eu.occtet.boc.entity.Vulnerability;
import eu.occtet.boc.dao.VulnerabilityRepository;
import eu.occtet.boc.vulnerability.factory.VulnerabilityFactory;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.test.context.ContextConfiguration;

import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;

@DataJpaTest
@ContextConfiguration(classes = {VulnerabilityService.class, VulnerabilityRepository.class, VulnerabilityFactory.class})
@EnableJpaRepositories(basePackages = "eu.occtet.boc.vulnerability.dao")
@EntityScan(basePackages = "eu.occtet.boc.entity")
public class VulnerabilityServiceTest {

    @Autowired
    private VulnerabilityService vulnerabilityService;
    @Autowired
    private VulnerabilityRepository vulnerabilityRepository;


    @Test
    void testCreatingNewVulnerability() {
        Vulnerability vulnerability = vulnerabilityService.getOrCreate(
                "VCID-nze3-w2ta-aaas",
                "Deserialization of Untrusted Data in Gson",
                List.of("CVE-2022-25647","GHSA-4jrv-ppp4-jm57"),
                4.0,
                0.5,
                8.0,
                List.of("http://public.vulnerablecode.io/packages/pkg:maven/com.google.code.gson/gson@2.8.9"),
                "http://public.vulnerablecode.io/vulnerabilities/VCID-nze3-w2ta-aaas",
                List.of("1","2","3")
        );
        assertNotNull(vulnerability.getId());
        Optional<Vulnerability> found = vulnerabilityRepository.findByVulnerabilityId("VCID-nze3-w2ta-aaas");
        assertTrue(found.isPresent(), "Vulnerability should be persisted in the repository");

        Vulnerability saved = found.get();
        assertEquals("Deserialization of Untrusted Data in Gson", saved.getSummary());
        assertEquals(4.0, saved.getWeightedSeverity());
        assertEquals(0.5, saved.getExploitability());
        assertEquals("Deserialization of Untrusted Data in Gson", saved.getSummary());
        assertEquals(4.0, saved.getWeightedSeverity());
        assertEquals(0.5, saved.getExploitability());
        assertEquals(8.0, saved.getRiskScore());
        assertEquals(List.of("CVE-2022-25647", "GHSA-4jrv-ppp4-jm57"), saved.getAliases());
        assertEquals(List.of("http://public.vulnerablecode.io/packages/pkg:maven/com.google.code.gson/gson@2.8.9"), saved.getFixedPackages());
        assertEquals("http://public.vulnerablecode.io/vulnerabilities/VCID-nze3-w2ta-aaas", saved.getSourceUrl());
        assertEquals(List.of("1", "2", "3"), saved.getReferences());
    }

    @Test
    void testUpdatingPreExistingVulnerability(){
        Vulnerability original = vulnerabilityService.getOrCreate(
                "VCID-nze3-w2ta-aaas",
                "Old summary",
                List.of("CVE-2022-25647"),
                2.0,
                0.1,
                3.0,
                List.of("pkg:maven/com.google.code.gson/gson@2.8.9"),
                "http://old-source",
                List.of("ref1")
        );
        assertEquals(1, vulnerabilityRepository.count());
        vulnerabilityService.getOrCreate(
                "VCID-nze3-w2ta-aaas",
                "New summary",
                List.of("CVE-2022-25647", "GHSA-4jrv-ppp4-jm57"),
                4.0,
                0.5,
                8.0,
                List.of("pkg:maven/com.google.code.gson/gson@2.10.1"),
                "http://new-source",
                List.of("ref1", "ref2")
        );
        assertEquals(1, vulnerabilityRepository.count());
        assertEquals("New summary", original.getSummary());
        assertEquals(List.of("CVE-2022-25647", "GHSA-4jrv-ppp4-jm57"), original.getAliases());
        assertEquals(4.0, original.getWeightedSeverity());
        assertEquals(0.5, original.getExploitability());
        assertEquals(8.0, original.getRiskScore());
        assertEquals(List.of("pkg:maven/com.google.code.gson/gson@2.10.1"), original.getFixedPackages());
        assertEquals("http://new-source", original.getSourceUrl());
        assertEquals(List.of("ref1", "ref2"), original.getReferences());
    }
}
