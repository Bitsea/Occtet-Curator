<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
  ~ Copyright (C) 2025 Bitsea GmbH
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     https:www.apache.orglicensesLICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  ~
  ~ SPDX-License-Identifier: Apache-2.0
  ~ License-Filename: LICENSE
  -->

<view xmlns="http://jmix.io/schema/flowui/view"
      title="msg://auditView.title">
    <data>
        <collection id="inventoryItemDc"
                    class="eu.occtet.bocfrontend.entity.InventoryItem">
            <loader id="inventoryItemDl">
                <query>
                    <![CDATA[
                        select distinct e
                        from InventoryItem e
                        where e.project = :project
                        and (
                            :vulnerableOnly = false
                            or (
                                e.softwareComponent is not null
                                and e.softwareComponent.vulnerabilities is not empty
                            )
                        )
                        order by e.inventoryName
                    ]]>
                </query>
            </loader>
            <fetchPlan extends="_local">
                <property name="parent" fetchPlan="_base"/>
            </fetchPlan>
        </collection>
        <collection id="fileDc" class="eu.occtet.bocfrontend.entity.File">
            <fetchPlan extends="_base">
                <property name="parent" fetchPlan="_base"/>
            </fetchPlan>
        </collection>

    </data>
    <facets>
        <dataLoadCoordinator auto="true"/>
    </facets>
    <layout  padding="false" spacing="false" width="100%" height="100%">
        <hbox width="100%" height="100%">
            <split themeNames="small" width="100%">
                <split width="80%" themeNames="small">
                    <vbox classNames="border rounded-m border-contrast-20" width="20%" margin="false" padding="false"
                          spacing="false">
                        <comboBox id="projectComboBox" label="Choose project" width="97%" alignSelf="CENTER"/>
                        <vbox id="fileTreeGridLayout" width="100%" height="100%" margin="false" padding="false"
                              spacing="false">
                            <treeDataGrid id="fileTreeGrid"
                                          dataContainer="fileDc"
                                          height="100%"
                                          width="100%"
                                          themeNames="no-row-borders compact row-stripes"
                                          hierarchyProperty="parent" showOrphans="true">
                                <columns>
                                    <column property="fileName" header="File" filterable="false"/>
<!--                                    filterable must stay false -->
                                </columns>
                            </treeDataGrid>
                        </vbox>
                    </vbox>
                    <tabSheet id="mainTabSheet" width="84%" height="100%" themeNames="no-padding" >
                        <tab id="overviewProjectSection" label="Overview">
                            <fragment class="eu.occtet.bocfrontend.view.audit.fragment.OverviewProjectTabFragment"
                                      id="overviewProjectTabFragment"/>
                        </tab>
                        <tab id="inventoryItemSection" label="msg://inventoryItems" visible="false">
                            <tabSheet id="inventoryItemTabSheet" width="100%" height="100%"
                                      themeNames="small no-padding">
                            </tabSheet>
                        </tab>
                        <tab id="filesSection" label="Files" visible="false">
                            <tabSheet id="filesTabSheet" width="100%" height="100%" themeNames="no-padding small">
                            </tabSheet>
                        </tab>
                    </tabSheet>
                </split>
                <vbox classNames="toolbox-audit-view" width="16%" margin="false" padding="false"
                      spacing="false">
                    <button id="createBtn"
                            action="inventoryItemDataGrid.create"
                            icon="PLUS"
                            themeNames="small"
                            title="msg://createInventoryItem"
                            alignSelf="END"/>
                    <hbox id="toolbarBox"
                          width="100%"
                          height="auto"
                          justifyContent="CENTER"
                          margin="false">
                    </hbox>
                    <treeDataGrid id="inventoryItemDataGrid"
                                  dataContainer="inventoryItemDc"
                                  height="100%"
                                  width="100%"
                                  themeNames="no-row-borders compact row-stripes"
                                  hierarchyProperty="parent" showOrphans="true">
                        <actions>
                            <action id="create" type="list_create"/>
                        </actions>
                        <columns>
                            <column property="inventoryName" header="Item" filterable="true"/>
                            <column key="fileNumCol" header="Files #" textAlign="END" sortable="false" autoWidth="true" flexGrow="0"/>
                            <column key="status" autoWidth="true" flexGrow="0" sortable="false" textAlign="CENTER"/>
                        </columns>
                    </treeDataGrid>
                </vbox>
            </split>
        </hbox>
    </layout>
</view>