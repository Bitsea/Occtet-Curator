<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
        * Copyright (C) 2025 Bitsea GmbH
        *
        * Licensed under the Apache License, Version 2.0 (the "License");
        * you may not use this file except in compliance with the License.
        * You may obtain a copy of the License at
        *
        *     https:www.apache.orglicensesLICENSE-2.0
        *
        * Unless required by applicable law or agreed to in writing, software
        * distributed under the License is distributed on an "AS IS" BASIS,
        * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        * See the License for the specific language governing permissions and
        * limitations under the License.
        *
        * SPDX-License-Identifier: Apache-2.0
        * License-Filename: LICENSE
        */
  -->
<view xmlns="http://jmix.io/schema/flowui/view"
      xmlns:charts="http://jmix.io/schema/charts/ui"
      title="msg://dashboardView.title">
    <data>
        <collection id="projectsDc" class="eu.occtet.bocfrontend.entity.Project">
            <fetchPlan extends="_base"/>
            <loader id="projectsDl">
                <query>
                    <![CDATA[select e from Project e]]>
                </query>
            </loader>
        </collection>

        <collection id="vulnerabilitiesDc" class="eu.occtet.bocfrontend.entity.Vulnerability">
            <fetchPlan extends="_base"/>
            <loader id="vulnerabilitiesDl">
                <query>
                    <![CDATA[
                    select distinct v from InventoryItem ii
                    join ii.softwareComponent sc
                    join sc.vulnerabilities v
                    where ii.project = :component_projectSelector
                    ]]>
                </query>
            </loader>
        </collection>
    </data>

    <facets>
        <dataLoadCoordinator auto="true"/>
    </facets>

    <layout>
        <vbox width="100%" height="100%" expand="vulnerabilitiesGrid">

            <entityComboBox id="projectSelector"
                            label="Select Project"
                            themeNames="small"
                            itemsContainer="projectsDc"
                            metaClass="Project"
                            width="20em"/>

            <dataGrid id="vulnerabilitiesGrid"
                      dataContainer="vulnerabilitiesDc"
                      classNames="occtet-grid"
                      width="100%"
                      minHeight="20em">
                <columns>
                    <column property="vulnerabilityId" header="Vulnerability ID" autoWidth="true"/>
                    <column property="riskScore" header="Risk Score"/>
                    <column property="weightedSeverity" header="Severity"/>
                    <column property="summary" header="Summary"/>
                </columns>
            </dataGrid>
            <vbox width="100%" height="100%" alignItems="END">
                <charts:chart id="chartVulnerabilites" width="100%" height="100%" justifySelf="CENTER">
                    <charts:title text="Vulnerability risk scores"/>
                    <charts:series>
                        <charts:pie id="PieChart" startAngle="80" selectedMode="SINGLE">
                            <charts:label formatter="{b}: {d}%"/>
                        </charts:pie>
                    </charts:series>
                </charts:chart>
            </vbox>
        </vbox>
    </layout>
</view>